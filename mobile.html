<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>J interpreter</title>
    <script src="jquery-1.7.1.min.js"></script>
    <style>
      body { font-family: arial; }
      textarea { font-size: 16px!important}
      textarea:focus { font-size: 16px!important}
    </style>

    </head>
<body>
    
<script type="text/javascript">
  var myterm = false;
  var Module = {
    noInitialRun: true,
    noExitRuntime: true,
    preRun: [],
    postRun: [],
    print: (function() {
        return function(text) {
            $('#Output').val( $('#Output').val() + text + "\n");
        };
    })()
  };
</script>
<script type="text/javascript" src="j-formatted.min.js"></script>
<script type="text/javascript">
  var process = Module.cwrap('process_wrapper', null, ['string']);
</script>

<textarea id="Input" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
<textarea id="Output"></textarea>

<script>
$(function() {
  Module.ccall('main', null, null, null);
  process("smoutput=: 0 0 $ 1!:2&2");

    var output = function(text) {
        $('#Output').val( text + '\n' + $('#Output').val());
    }

    var resize = function() {
        var width = $(window).width()-35;
        var height = $(window).height()-300;
        $('#Input').height(320).width(width);
        $('#Output').height(120).width(width);
        return false;
    }
    
    output('started');
    resize();

    var mode = '111';
    var runScript = function() {
        var jtinpl = Module.cwrap('jtinpl', 'number', ['number', 'number', 'number', 'string'])
        var a=HEAP32[31136];
        var noun='input_jfe_';

        txt=$('#Input').val();

        var jtnfs = Module.cwrap('jtnfs', 'number', ['number', 'number', 'string'])
        var script = jtinpl(a, 0, txt.length, txt);
        var jt_global = HEAP32[a+204520>>2];
        
        var ret = _jtsymbis(a, jtnfs(a,noun.length,noun),script, jt_global)

        $('#Output').val('');
        process('(0!:' + mode + ') ' + noun);
    }

    $('#Clear').click(function() {
        $('#Input').val('');
    });

    function getLineNumber(textarea) {
        return (textarea.value.substr(0, textarea.selectionStart).split("\n").length)
    }

    $.fn.selectRange = function(start, end) {
        if(!end) end = start; 
        return this.each(function() {
            if (this.setSelectionRange) {
                this.focus();
                this.setSelectionRange(start, end);
            } else if (this.createTextRange) {
                var range = this.createTextRange();
                range.collapse(true);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.select();
            }
        });
    };
    var fireChord = function(key) {
        //output('chord hit ' + key);
        if (key == 88 /* 'x' */) {
            runScript();
        }
        if (key == 86 /* v */) {
            $('#Input').height($('#Input').height()+100);
        }
        if (key == 83 /* S */) {
            $('#Input').height($('#Input').height()-100);
        }
        if (key == 67 /* c */) {
            $('#Output').val('');
        }
        if (key == 65 /* a */) {
            $('#Input').select();
        }
        if (key == 16 /* A */) {
            $('#Output').select();
        }
        if (key == 68 /* d */) {
            $('#CanvasDialog').show();
        }
        if (key == 49 /* 1 */) {
            $('#Input').val( $('#Input').val() + "'drawRect' (15!:0) (10,10,100,100)\n")
            $('#CanvasDialog').show();
            runScript();
        }
        if (key == 48 /* 0 */) {
            $('#Output').val('');
            $('#Input').val( $('#Input').val() + 'smoutput <"0 i.5\n')
            runScript();
        }
        if (key == 79 /* o */) {
            $('#Input').val( $('#Input').val() + "smoutput ")
        }
        if (key == 89 /* y */) {
            var line = getLineNumber($('#Input')[0])-1;
            var lines = $.grep($('#Input').val().split('\n'), function(x,i) { return i != line }).join("\n");
            $('#Input').val(lines);
        }
        if (key  == 72 /* k */) {
            var pos = $('#Input')[0].selectionStart;
            $('#Input').selectRange(pos-1,pos-1);
        }
        if (key  == 76 /* l */) {
            var pos = $('#Input')[0].selectionStart;
            $('#Input').selectRange(pos+1,pos+1);
        }
        if (key == 80) {
            mode = '100'; //hide output
        }

    }
    var chordTime = 0;
    var chordWait = false;
    var helpTimer = 0;

    var showHelp = function() {
        output('showing help');
        $('#Help').show();
    }

    var noChordTimer = 0;
    var CHORD_TIME = 750;

    
    $('#Input').on('keydown', function(e) {
        $('#CanvasDialog').hide();
        if (noChordTimer) { clearInterval(noChordTimer) }

        var keyCode = (e.keyCode ? e.keyCode : e.which);
        //output(keyCode);
        if (chordWait) {
            fireChord(keyCode);
            clearInterval(helpTimer);
            $('#Help').hide();
            chordWait = false;
            e.preventDefault();
            return false;
        }
        if (e.keyCode == 81) {
            var ts = $.now();
            if (chordTime != 0 && ts < chordTime) {
                chordWait = true;
                if (helpTimer) { clearInterval(helpTimer); }
                helpTimer = setTimeout(showHelp, 2000);
            } else {
                noChordTimer = setTimeout(function() { $('#Input').val( $('#Input').val() + 'q') }, CHORD_TIME+100);
            }
            chordTime = ts + CHORD_TIME;
            e.preventDefault();
            return false;
        }
        
    });

    $('#Input').focus();
    $('#Input').val('');
    $('#Output').val('type qq for help. remember to use smoutput to output results');
});


var rank = function(f) { return HEAP32[16+f>>2] }
var shape = function(f) { return HEAP32[20+f>>2] }
var ravelPtr = function(f) { return HEAP32[f>>2]; }
var val = function(f,size,idx) {
    return HEAP32[(ravelPtr(f) + (idx*size) +f)>>2];
}
var typei = function(f) { return HEAP32[12+f>>2] };

var INT=1;
var LIT=2;
var ARR=4;
var BOX=32;

FUNCTION_TABLE[3295] = function(a,f,d) {
    var x ='';
    var y = '';
    
    if (typei(f) == LIT)
        x = Pointer_stringify(f+ravelPtr(f),shape(f));
    if (typei(d) == LIT)
        y = Pointer_stringify(d+ravelPtr(d),shape(d));

    if (typei(f) == INT)
        x = val(f,4,0);

    if (typei(d) == INT) {
        //y = Array.apply(null, Array(shape(d))).map(function(_,i) { return val(d, 4, i) });
        //y = HEAP32.subarray(d+ravelPtr(d)>>2,d+ravelPtr(d)+shape(d)>>2);
        y = val(d,4,0);
    }

    //note: there is strange behavior if y is 1 or 0 array
    if (typei(d) == ARR) {
        y = Array.apply(null, Array(shape(d))).map(function(_,i) { return val(d, 4, i) });
    }
    console.log(typei(d));
    
    if (x=='alert') {
        alert(y);
        a = HEAP32[31136];
        z = _jtga(a,INT,1,0);
        HEAP32[z+HEAP32[z>>2]>>2] = 1;
        return z;
    }
    if (x=='drawRect') {
        console.log(y);
        var canvas = document.getElementById("Canvas");
        var ctx = canvas.getContext("2d");
        ctx.fillRect(y[0],y[1],y[2],y[3])
        console.log(y);
    }
}



</script>
<div id="Help" style="display:none;z-index:1000;float:left;position:absolute;top:40px;left:40px;border:3px solid black;padding:10px;background-color:#f0f0f0;width:700px">
  To maximize screen space, all commands are executed with chords. The default chord is qq. To execute a command type qq quickly and then the chord key.<br>
  Keys:
    <ul>
    <li>x = run</li>
    <li>s = shrink input</li>
    <li>v = expand input</li>
    <li>c = clear output window</li>
    <li>a = select input text</li>
    <li>d = show canvas window</li>
    <li>1 = preset 1 (canvas example)</li>
    <li>0 = preset 0 (smoutput example)</li>
    <li>o = add smoutput</li>
    <li>y = kill current line</li>
    <li>h = move left, l = move right</li>
    </ul>
</div>
<div id="CanvasDialog" style="display:none;z-index:1000;float:left;position:absolute;top:40px;left:40px;border:3px solid black;padding:10px;background-color:#f0f0f0;width:500px">
      <canvas id="Canvas" width="500" height="500" style="border:1px solid #000000;">
      </canvas>
</div>

</body>
</html>
    
