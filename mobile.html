<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>J interpreter</title>
    <script src="jquery-1.7.1.min.js"></script>
    <style>
      body { font-family: arial; }
      textarea { font-size: 16px!important}
      textarea:focus { font-size: 16px!important}
      ul { margin:0;}
    </style>

    </head>
<body>
    
<script type="text/javascript">
  var myterm = false;
  var Module = {
    noInitialRun: true,
    noExitRuntime: true,
    preRun: [],
    postRun: [],
    print: (function() {
        return function(text) {
            $('#Output').val( $('#Output').val() + text + "\n");
        };
    })()
  };
</script>
<script type="text/javascript" src="j-formatted.min.js"></script>
<script type="text/javascript">
  var process = Module.cwrap('process_wrapper', null, ['string']);
</script>

<textarea id="Input" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
<textarea id="Output"></textarea>

<script>
$(function() {
  Module.ccall('main', null, null, null);
  process("smoutput=: 0 0 $ 1!:2&2");

    var output = function(text) {
        $('#Output').val( text + '\n' + $('#Output').val());
    }

    var resize = function() {
        var width = $(window).width()-35;
        var height = $(window).height()*0.5
        $('#Input').height(height-50).width(width);
        $('#Output').height(100).width(width);
        return false;
    }
    
    output('started');
    resize();

    var mode = '111';
    var runScript = function() {
        var jtinpl = Module.cwrap('jtinpl', 'number', ['number', 'number', 'number', 'string'])
        var a=HEAP32[31136];
        var noun='input_jfe_';

        txt=$('#Input').val();

        var jtnfs = Module.cwrap('jtnfs', 'number', ['number', 'number', 'string'])
        var script = jtinpl(a, 0, txt.length, txt);
        var jt_global = HEAP32[a+204520>>2];
        
        var ret = _jtsymbis(a, jtnfs(a,noun.length,noun),script, jt_global)

        $('#Output').val('');
        process('(0!:' + mode + ') ' + noun);
    }

    $('#Clear').click(function() {
        $('#Input').val('');
    });

    function getLineNumber(textarea) {
        return (textarea.value.substr(0, textarea.selectionStart).split("\n").length)
    }

    $.fn.selectRange = function(start, end) {
        if(!end) end = start; 
        return this.each(function() {
            if (this.setSelectionRange) {
                this.focus();
                this.setSelectionRange(start, end);
            } else if (this.createTextRange) {
                var range = this.createTextRange();
                range.collapse(true);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.select();
            }
        });
    };



    var keyCodeToChar = {8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};


    
    var chordTime = 0;
    var chordWait = false;
    var helpTimer = 0;

    var showHelp = function() {
        output('showing help');
        $('#Help').show();
    }

    var noChordTimer = 0;
    var CHORD_TIME = 1000;

    function fireChordKeys(keys) {
        if (keys == 'QR') {
            runScript();
        }
        else if (keys == 'QQX') {
            runScript();
        }
        else if (keys == 'QIV') {
            $('#Input').height($('#Input').height()+100);
        }
        else if (keys == 'QIS') {
            $('#Input').height($('#Input').height()-100);
        }
        else if (keys == 'QIC') {
            $('#Input').val('');
        }
        else if (keys == 'QIA') {
            $('#Input').select();
        }
        else if (keys == 'QOV') {
            $('#Output').height($('#Output').height()+100);
        }
        else if (keys == 'QOS') {
            $('#Output').height($('#Output').height()-100);
        }
        else if (keys == 'QOC') {
            $('#Output').val('');
        }
        else if (keys == 'QOA') {
            $('#Output').select();
        }

        else if (keys == 'QCD') {
            $('#CanvasDialog').show();
        }
        else if (keys == 'QP1') {
            $('#Input').val( $('#Input').val() + "'drawRect' (15!:0) (10,10,100,100)\n")
            $('#CanvasDialog').show();
            runScript();
        }
        else if (keys == 'QP0') {
            $('#Output').val('');
            $('#Input').val( $('#Input').val() + 'smoutput <"0 i.5\n')
            runScript();
        }
        else if (keys == 'QP2') {
            $('#Input').val( $('#Input').val() + "smoutput ")
        }
        else if (keys == 'QQY') {
            var line = getLineNumber($('#Input')[0])-1;
            var lines = $.grep($('#Input').val().split('\n'), function(x,i) { return i != line }).join("\n");
            $('#Input').val(lines);
        }
        else if (keys == 'QMH') {
            var pos = $('#Input')[0].selectionStart;
            $('#Input').selectRange(pos-1,pos-1);
        }
        else if (keys  == 'QML') {
            var pos = $('#Input')[0].selectionStart;
            $('#Input').selectRange(pos+1,pos+1);
        }
        else if (keys == 'QTO') {
            if (mode == '111') {
                mode = '100'
            } else {
                mode = '111';
            }
            output('mode is now 0!:' + mode);
        }

    }

    var chord='';
    
    $('#Input, #Output').on('keydown', function(e) {
        $('#CanvasDialog').hide();
        if (noChordTimer) { clearInterval(noChordTimer) }

        var keyCode = (e.keyCode ? e.keyCode : e.which);
        var key = keyCodeToChar[keyCode];
        //output(keyCode);

        var ts = $.now();

        var fire = false;

        if (chordWait) {
            chord+=key;
            //console.log(chord);
            fireChordKeys(chord);
            
            clearInterval(helpTimer);
            $('#Help').hide();
            chordWait = false;
            e.preventDefault();
            return false;
        }
        if (e.keyCode == 81) {
            if (chordTime != 0 && ts < chordTime) {
                chord = chord + 'Q';
                chordWait = true;
                if (helpTimer) { clearInterval(helpTimer); }
                helpTimer = setTimeout(showHelp, 2000);
            } else {
                noChordTimer = setTimeout(function() { $('#Input').val( $('#Input').val() + 'q') }, CHORD_TIME+100);
                chord = 'Q';
            }
            chordTime = ts + CHORD_TIME;
            e.preventDefault();
            return false;
        }
        else if (chordTime != 0 && ts < chordTime) {
            var startChord = false;
            if (key == 'R') {
                chord = chord + key;
                fire = true;
            }
            if (key == 'I' || key == 'O' || key == 'P' || key == 'M' || key == 'C' || key == 'T') {
                startChord = true;
            }

            if (startChord) {
                chord+=key;
                chordWait = true;
                chordTime = ts + CHORD_TIME;
                e.preventDefault();
            }
            if (fire) {
                fireChordKeys(chord);
                e.preventDefault();
            }
        }
        
    });

    $('#Input').focus();
    $('#Input').val('');
    $('#Output').val('type qq for help. remember to use smoutput to output results');
});


var rank = function(f) { return HEAP32[16+f>>2] }
var shape = function(f) { return HEAP32[20+f>>2] }
var ravelPtr = function(f) { return HEAP32[f>>2]; }
var val = function(f,size,idx) {
    return HEAP32[(ravelPtr(f) + (idx*size) +f)>>2];
}
var typei = function(f) { return HEAP32[12+f>>2] };

var INT=1;
var LIT=2;
var ARR=4;
var BOX=32;

FUNCTION_TABLE[3295] = function(a,f,d) {
    var x ='';
    var y = '';
    
    if (typei(f) == LIT)
        x = Pointer_stringify(f+ravelPtr(f),shape(f));
    if (typei(d) == LIT)
        y = Pointer_stringify(d+ravelPtr(d),shape(d));

    if (typei(f) == INT)
        x = val(f,4,0);

    if (typei(d) == INT) {
        //y = Array.apply(null, Array(shape(d))).map(function(_,i) { return val(d, 4, i) });
        //y = HEAP32.subarray(d+ravelPtr(d)>>2,d+ravelPtr(d)+shape(d)>>2);
        y = val(d,4,0);
    }

    //note: there is strange behavior if y is 1 or 0 array
    if (typei(d) == ARR) {
        y = Array.apply(null, Array(shape(d))).map(function(_,i) { return val(d, 4, i) });
    }
    console.log(typei(d));
    
    if (x=='alert') {
        alert(y);
        a = HEAP32[31136];
        z = _jtga(a,INT,1,0);
        HEAP32[z+HEAP32[z>>2]>>2] = 1;
        return z;
    }
    if (x=='drawRect') {
        console.log(y);
        var canvas = document.getElementById("Canvas");
        var ctx = canvas.getContext("2d");
        ctx.fillRect(y[0],y[1],y[2],y[3])
        console.log(y);
    }
}



</script>
<div id="Help" style="display:none;z-index:1000;float:left;position:absolute;top:40px;left:40px;border:3px solid black;padding:10px;background-color:#f0f0f0;width:700px">
  To maximize screen space, all commands are executed by a sequence of keys. qq brings up help.
  General Keys:
    <ul>
    <li>qr or qqx = run</li>
    <li>qqy = kill current line</li>
    <li>qto = toggle output of script in window (off means you must use smoutput)</li>
    </ul>
    Window Keys (prefix is qo or qi -- mnemonic of i for input or o for output)
    <ul>
    <li>qis / qos = shrink</li>
    <li>qiv / qov = expand</li>
    <li>qic / qoc = clear</li>
    <li>qia / qoa = select</li>
    </ul>
    Canvas Keys (prefix is qc)
    <ul>
    <li>qcd = show canvas window</li>
    </ul>
    Preset Keys (prefix qp)
    <ul>
    <li>qp1 = preset 1 (canvas example)</li>
    <li>qp0 = preset 0 (smoutput example)</li>
    <li>qpo = add smoutput</li>
    </ul>
    Movement keys (prefix qm)
    <ul>
    <li>h = move left, l = move right</li>
    </ul>
</div>
<div id="CanvasDialog" style="display:none;z-index:1000;float:left;position:absolute;top:40px;left:40px;border:3px solid black;padding:10px;background-color:#f0f0f0;width:500px">
      <canvas id="Canvas" width="500" height="500" style="border:1px solid #000000;">
      </canvas>
</div>

</body>
</html>
    
